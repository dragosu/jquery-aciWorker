
/*
 * aciWorker jQuery Plugin v1.0.0
 * http://acoderinsights.ro
 *
 * Copyright (c) 2013 Dragos Ursu
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Require jQuery Library >= v1.6.0 http://jquery.com
 * + aciPlugin >= v1.4.0 https://github.com/dragosu/jquery-aciPlugin
 */

/*
 * IMPORTANT: `aciWorker.js` script file need to be located on the same path
 * as this file so it can be used on web worker init !
 */

(function(g,f,h){var b={worker:true,interval:100,delay:10};var e=g("script:last").attr("src");e=e.slice(0,e.lastIndexOf("/")+1);var d=f.location.pathname;d=d.slice(0,d.lastIndexOf("/")+1);var a={__extend:function(){g.extend(this._instance,{worker:null,store:new f.Object(),lastIndex:0,used:0,queue:new this._queue(this),interval:0})},init:function(){if(this.wasInit()){return}if(f.Worker){this._instance.worker=new f.Worker(e+"aciWorker.js");this._instance.worker.addEventListener("message",this.proxy(function(i){if(i.data.uid){this._call(i.data.uid,i.data)}if(i.data.exception){throw new Error(i.data.result)}}),false)}this._super()},_uid:function(){this._instance.lastIndex++;return this._instance.index+":"+this._instance.lastIndex},_store:function(j){this._instance.used++;if(this._instance.used==1){this._instance.store=new f.Object();this._instance.lastIndex=0}var i=this._uid();this._instance.store[i]=j;return i},_call:function(i,j){if(this._instance.store[i]){this._instance.store[i].call(f,j);this._instance.store[i]=null;this._instance.used--}},_dispatch:function(j,i,k){if(k){if(j.task=="isset"){i=!(j.exception||(i===h)||(i=="undefined"))}j.result=i;k.call(this,j)}},_scripts:function(k){if(k instanceof f.Array){for(var j in k){if((k[j].indexOf("/")!=0)&&(k[j].search(/^https?:/i)==-1)){k[j]=d+k[j]}}}else{if((k.indexOf("/")!=0)&&(k.search(/^https?:/i)==-1)){k=d+k}}return k},_queue:function(m){var l=[];var n=0;var k=false;var o=function(){if((n>=1)||k){return}var r=l.shift();if(r){n++;if(r.call){var q=new f.Date().getTime();if(q-m._instance.interval>m._instance.options.interval){m._instance.interval=q+m._instance.options.delay;i();r.callback(function(){n--;f.setTimeout(function(){p()},m._instance.options.delay)});return}}r.callback(function(){n--})}};var j=new Array();var p=function(){for(var q=0;q<16;q++){j[q]=f.setInterval(o,1)}};var i=function(){for(var q in j){f.clearInterval(j[q])}};p();this.push=function(r,q){if(!k){l.push({callback:r,call:q})}};this.destroy=function(){k=true;i();l=[];n=0;k=false}},execute:function(i,j,k){j.task=i;if(this._instance.worker&&this._instance.options.worker){if(k){j.uid=this._store(k)}if(i=="load"){j.file=this._scripts(j.file)}this._instance.worker.postMessage(j)}else{this._instance.queue.push(this.proxy(function(l){try{switch(i){case"load":if(j.file instanceof f.Array){var o=this._scripts(j.file);var n=this.proxy(function(){var p=o.shift();if(p){g.ajax({url:p,success:n,dataType:"script"})}else{this._dispatch(j,null,k);l()}});n()}else{g.ajax({url:this._scripts(j.file),success:this.proxy(function(){this._dispatch(j,null,k);l()}),dataType:"script"})}break;case"isset":case"get":this._dispatch(j,c.get(j.name),k);break;case"set":this._dispatch(j,c.set(j.name,j.data),k);break;case"ifset":this._dispatch(j,c.ifset(j.name,j.data),k);break;case"toString":this._dispatch(j,c.toString(j.name),k);break;case"call":this._dispatch(j,c.call(j.name,j.data),k);break;case"construct":this._dispatch(j,c.construct(j.name,j.type,j.data),k);break;case"destruct":this._dispatch(j,c.destruct(j.name),k);break;case"destroy":this._dispatch(j,null,k);break;default:throw new Error("Unknown task requested ["+i+"]")}if(i!="load"){l()}}catch(m){j.exception=true;this._dispatch(j,m.toString(),k);l();if(i!="isset"){throw new Error(m.toString())}}}),i=="call")}return this},load:function(i,j){this.execute("load",i,j);return this},isset:function(i,j){this.execute("isset",i,j);return this},get:function(i,j){this.execute("get",i,j);return this},set:function(i,j){this.execute("set",i,j);return this},ifset:function(i,j){this.execute("ifset",i,j);return this},toString:function(i,j){this.execute("toString",i,j);return this},call:function(i,j){this.execute("call",i,j);return this},construct:function(i,j){this.execute("construct",i,j);return this},destruct:function(i,j){this.execute("destruct",i,j);return this},destroy:function(){if(!this.wasInit()){return}if(this._instance.worker){this._instance.worker.postMessage({task:"destroy"})}this._instance.queue.destroy();this._super()}};aciPluginClass.plugins.aciWorker=aciPluginClass.aciPluginUi.extend(a,"aciWorkerCore");aciPluginClass.publish("aciWorker",b);var c={_object:function(k){var m=k.split(".");if(m.length>1){var j=this.context;for(var l in m){if(!j){throw new Error("Trying to access [."+m[l]+"] but ["+m.slice(0,l).join(".")+"] is undefined")}j=j[m[l]]}return j}return this.context[k]},_parent:function(j,n){var o=j.split(".");if(o.length>1){var l=this.context,m;for(var k in o){if(!l){throw new Error("Trying to access [."+o[k]+"] but ["+o.slice(0,k).join(".")+"] is undefined")}m=l;l=l[o[k]]}n.name=o[k];return m}n.name=j;return this.context},get:function(i){return this._object(i)},set:function(i,l){var k={name:null};var j=this._parent(i,k);j[k.name]=l},ifset:function(i,j){var k=this.get(i);if(k===h){this.set(i,j)}},toString:function(i){return this._object(i).toString()},call:function(i,l){var k={name:null};var j=this._parent(i,k);if(typeof j[k.name]!="function"){throw new Error("Trying to call [."+k.name+"] but ["+i+"] is not a function")}if(l!==h){if(l instanceof f.Array){return j[k.name].apply(j,l)}else{return j[k.name].call(j,l)}}else{return j[k.name].call(j)}},construct:function(i,k,m){var l={name:null};var j=this._parent(i,l);j[l.name]=this._object(k);if(typeof j[l.name]!="function"){throw new Error("Trying to construct [."+l.name+"] but ["+i+"] is not a function")}if(m===h){j[l.name]=new j[l.name]()}else{if(m instanceof f.Array){switch(m.length){case 0:j[l.name]=new j[l.name]();break;case 1:j[l.name]=new j[l.name](m[0]);break;case 2:j[l.name]=new j[l.name](m[0],m[1]);break;case 3:j[l.name]=new j[l.name](m[0],m[1],m[2]);break;case 4:j[l.name]=new j[l.name](m[0],m[1],m[2],m[3]);break}}else{j[l.name]=new j[l.name](m)}}},destruct:function(j){var i={name:null};var k=this._parent(j,i);k[i.name]=null}};c.context=f})(jQuery,this);
